<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeChain Explorer | Solscan Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1c1c1c;
            --bg-header: #181818;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #00ffd5;
            /* Solscan-ish Green/Cyan */
            --border: #2c2c2c;
            --hover: #2a2a2a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            font-size: 14px;
        }

        /* Navbar */
        .navbar {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-circle {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 900;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: #252525;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        /* Nav Links */
        .nav-links {
            display: flex;
            gap: 20px;
            margin: 0 24px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 13px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 24px;
        }

        /* Market Cards */
        .market-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .card-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .flashing {
            animation: flash 1s;
        }

        @keyframes flash {
            0% {
                color: var(--accent);
            }

            100% {
                color: var(--text-primary);
            }
        }

        /* Split View */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
        }

        .view-all {
            color: var(--accent);
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }

        .table-row {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: var(--hover);
        }

        .row-icon {
            width: 40px;
            height: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: var(--text-secondary);
        }

        .row-data {
            flex: 1;
        }

        .row-primary {
            display: block;
            color: var(--accent);
            margin-bottom: 4px;
            cursor: pointer;
        }

        .row-secondary {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .row-meta {
            text-align: right;
        }

        .badge-pill {
            background: rgba(0, 255, 213, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Error/Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #252525;
            padding: 8px 24px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
        }

        @media (max-width: 900px) {
            .market-overview {
                grid-template-columns: 1fr 1fr;
            }

            .split-view {
                grid-template-columns: 1fr;
            }

            .search-bar {
                display: none;
            }

            /* Hide on mobile for simplicity */
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="brand" onclick="switchTab('home')" style="cursor:pointer">
            <img src="logo.png" alt="HomeChain" style="height: 38px; width: auto; border-radius: 8px;">
            <span>HomeChainScan</span>
        </div>
        <div class="nav-links">
            <a href="javascript:void(0)" class="nav-link active" id="nav-home" onclick="switchTab('home')">Home</a>
            <a href="javascript:void(0)" class="nav-link" id="nav-blocks" onclick="switchTab('blocks')">Blocks</a>
            <a href="javascript:void(0)" class="nav-link" id="nav-txs" onclick="switchTab('txs')">Transactions</a>
            <a href="javascript:void(0)" class="nav-link" id="nav-holders" onclick="switchTab('holders')">Holders</a>
            <a href="javascript:void(0)" class="nav-link" id="nav-analytics"
                onclick="switchTab('analytics')">Analytics</a>
            <a href="javascript:void(0)" class="nav-link" id="nav-validators"
                onclick="switchTab('validators')">Validators</a>
        </div>
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search by Block, Transaction, Account">
        </div>
        <div class="status-indicator">
            <div id="connStatus" class="badge-pill" style="display:flex; align-items:center; gap:6px;">
                <div style="width:8px; height:8px; background:currentColor; border-radius:50%"></div>
                <span>CONNECTING...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Section (Home) -->
        <div id="section-home" class="page-section">
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">Block Height</div>
                    <div class="card-value" id="statHeight">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Network Difficulty</div>
                    <div class="card-value" id="statDiff">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Supply</div>
                    <div class="card-value" id="statSupply">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Holders</div>
                    <div class="card-value" id="statHolders">---</div>
                </div>
            </div>

            <div class="split-view">
                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Latest Blocks</div>
                        <a class="view-all" onclick="switchTab('blocks')">View All</a>
                    </div>
                    <div id="blocksListSummary">
                        <div style="padding:20px; text-align:center; color:#555">Loading blocks...</div>
                    </div>
                </div>

                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Latest Transactions</div>
                        <a class="view-all" onclick="switchTab('txs')">View All</a>
                    </div>
                    <div id="txListSummary">
                        <div style="padding:20px; text-align:center; color:#555">Loading transactions...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blocks Section -->
        <div id="section-blocks" class="page-section" style="display:none">
            <h2 style="margin-bottom:20px">Blocks</h2>
            <div class="card" style="padding:0">
                <div id="blocksListFull">
                    <div style="padding:40px; text-align:center; color:#555">Loading blockchain data...</div>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="section-txs" class="page-section" style="display:none">
            <h2 style="margin-bottom:20px">Transactions</h2>
            <div class="card" style="padding:0">
                <div id="txListFull">
                    <div style="padding:40px; text-align:center; color:#555">Loading transaction data...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="section-analytics" class="page-section" style="display:none">
            <h2 style="margin-bottom:20px">Network Analytics</h2>
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">TPS (Current)</div>
                    <div class="card-value">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Market Cap (Mock)</div>
                    <div class="card-value">$---</div>
                </div>
                <div class="card">
                    <div class="card-label">Avg. Block Time</div>
                    <div class="card-value">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Mining Revenue</div>
                    <div class="card-value">1.325M HOME/Block</div>
                </div>
            </div>
            <div class="card"
                style="height:300px; display:flex; align-items:center; justify-content:center; color:var(--text-secondary)">
                Hashrate & Difficulty Chart (Coming Soon with Supabase Integration)
            </div>
        </div>

        <!-- Validators Section -->
        <div id="section-validators" class="page-section" style="display:none">
            <h2 style="margin-bottom:20px">Active Validators</h2>
            <div class="card" style="padding:0" id="validatorsList">
                <div style="padding:40px; text-align:center; color:#555">Detecting network validators...</div>
            </div>
        </div>

        <!-- Holders Section -->
        <div id="section-holders" class="page-section" style="display:none">
            <h2 style="margin-bottom:20px">Top Holders</h2>
            <div class="card" style="padding:0">
                <div id="holdersList">
                    <div style="padding:40px; text-align:center; color:#555">Calculating balances...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar" id="debugLog">System Initialized.</div>

    <script>
        // Use the proxy endpoint
        const API = "/api/proxy?endpoint=";
        let globalChain = [];
        let currentTab = 'home';

        function log(msg) {
            const d = new Date().toLocaleTimeString();
            document.getElementById('debugLog').innerText = `[${d}] ${msg}`;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // Hide all sections
            document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
            // Show target
            document.getElementById(`section-${tabName}`).style.display = 'block';

            // Update Nav Active State
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navItem = document.getElementById(`nav-${tabName}`);
            if (navItem) navItem.classList.add('active');

            // Re-render data if we have it
            if (globalChain.length > 0) render(globalChain);
        }

        async function fetchChain() {
            try {
                const res = await fetch(`${API}/chain`);
                if (!res.ok) throw new Error(`Proxy status: ${res.status}`);

                const data = await res.json();
                if (!data || !data.chain) throw new Error("Invalid API response structure");

                globalChain = data.chain;
                render(globalChain);

                const statusEl = document.getElementById('connStatus');
                statusEl.querySelector('span').innerText = "OPERATIONAL";
                statusEl.style.color = "var(--accent)";
                statusEl.style.background = "rgba(0, 255, 213, 0.1)";
                log(`Synced. Height: ${globalChain.length}`);

            } catch (e) {
                console.error(e);
                const statusEl = document.getElementById('connStatus');
                statusEl.querySelector('span').innerText = "CONNECTION FAILED";
                statusEl.style.color = "#ff4d4d";
                statusEl.style.background = "rgba(255, 77, 77, 0.1)";
                log(`Error: ${e.message}. Retrying...`);
            }
        }

        function calculateHolders(chain) {
            const balances = {};
            let totalPossibleReward = 0;

            chain.forEach(block => {
                if (!block.transactions) return; // Skip blocks with no transactions
                block.transactions.forEach(tx => {
                    const amount = parseFloat(tx.amount) || 0;

                    // Sender decrease (unless SYSTEM)
                    if (tx.sender !== "SYSTEM") {
                        balances[tx.sender] = (balances[tx.sender] || 0) - amount;
                    }

                    // Receiver increase
                    balances[tx.receiver] = (balances[tx.receiver] || 0) + amount;
                });
            });

            // Convert to array and sort
            return Object.entries(balances)
                .map(([address, balance]) => ({ address, balance }))
                .filter(h => h.balance > 0)
                .sort((a, b) => b.balance - a.balance);
        }

        function render(chain) {
            try {
                if (!chain || chain.length === 0) return;
                const head = chain[chain.length - 1];

                // Global Stats
                document.getElementById('statHeight').innerText = chain.length.toLocaleString();

                // Difficulty Calculation: MaxTarget / CurrentTarget
                const MAX_TARGET = BigInt("0x0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
                const currentTarget = BigInt(head.target || MAX_TARGET);
                const relDiff = head.target ? (Number(MAX_TARGET) / Number(currentTarget)).toFixed(2) : "1.00";

                document.getElementById('statDiff').innerText = relDiff;

                const holders = calculateHolders(chain);
                const totalSupply = holders.reduce((acc, h) => acc + h.balance, 0);
                document.getElementById('statSupply').innerText = totalSupply.toLocaleString() + " HOME";
                document.getElementById('statHolders').innerText = holders.length.toLocaleString();

                // Blocks List (Summary & Full)
                const containerSummary = document.getElementById('blocksListSummary');
                const containerFull = document.getElementById('blocksListFull');

                if (containerSummary) containerSummary.innerHTML = '';
                if (containerFull) containerFull.innerHTML = '';

                const sortedBlocks = [...chain].reverse();

                sortedBlocks.forEach((b, idx) => {
                    const validator = b.validator ? b.validator : "00000000";
                    const validatorShort = validator.length > 12 ? validator.substring(0, 12) + '...' : validator;

                    const rowHtml = `
                        <div class="table-row">
                            <div style="display:flex; align-items:center;">
                                <div class="row-icon">BK</div>
                                <div class="row-data">
                                    <span class="row-primary">#${b.index}</span>
                                    <span class="row-secondary">${timeAgo(b.timestamp)}</span>
                                </div>
                            </div>
                            <div class="row-meta">
                                <span class="row-secondary">Validated by</span>
                                <span class="row-primary" style="font-size:12px">${validatorShort}</span>
                                <span class="badge-pill">${b.transactions ? b.transactions.length : 0} Txs</span>
                            </div>
                        </div>
                    `;

                    if (idx < 7 && containerSummary) containerSummary.innerHTML += rowHtml;
                    if (containerFull) containerFull.innerHTML += rowHtml;
                });

                // Transactions List (Summary & Full)
                const txSummary = document.getElementById('txListSummary');
                const txFull = document.getElementById('txListFull');

                if (txSummary) txSummary.innerHTML = '';
                if (txFull) txFull.innerHTML = '';

                let txCountSummary = 0;
                let txCountFull = 0;

                for (let b of sortedBlocks) {
                    if (!b.transactions) continue;

                    for (let tx of b.transactions) {
                        const txId = tx.id ? tx.id : "System/Reward";
                        const txIdShort = txId.length > 16 ? txId.substring(0, 16) + '...' : txId;

                        const receiver = tx.receiver ? tx.receiver : "Unknown";
                        const receiverShort = receiver.length > 12 ? receiver.substring(0, 12) + '...' : receiver;

                        const rowHtml = `
                            <div class="table-row">
                                <div style="display:flex; align-items:center;">
                                    <div class="row-icon" style="color:#fff; font-size:10px">TX</div>
                                    <div class="row-data">
                                        <span class="row-primary">${txIdShort}</span>
                                        <span class="row-secondary">Block #${b.index}</span>
                                    </div>
                                </div>
                                <div class="row-meta">
                                    <span class="badge-pill">+${tx.amount.toLocaleString()} HOME</span>
                                    <span class="row-secondary" style="margin-top:4px">To: ${receiverShort}</span>
                                </div>
                            </div>
                        `;

                        if (txCountSummary < 7 && txSummary) {
                            txSummary.innerHTML += rowHtml;
                            txCountSummary++;
                        }

                        if (txCountFull < 50 && txFull) {
                            txFull.innerHTML += rowHtml;
                            txCountFull++;
                        }
                    }
                }

                if (txCountSummary === 0 && txSummary) {
                    txSummary.innerHTML = '<div style="padding:20px; text-align:center; color:#555">No recent transactions</div>';
                }
                if (txCountFull === 0 && txFull) {
                    txFull.innerHTML = '<div style="padding:40px; text-align:center; color:#555">No transactions found.</div>';
                }

                // Holders List
                const holdersList = document.getElementById('holdersList');
                if (holdersList) {
                    holdersList.innerHTML = '';
                    holders.slice(0, 100).forEach((h, idx) => {
                        const stake = ((h.balance / totalSupply) * 100).toFixed(2);
                        holdersList.innerHTML += `
                            <div class="table-row">
                                <div style="display:flex; align-items:center;">
                                    <div class="row-icon" style="background:var(--accent); color:#000; font-weight:bold">${idx + 1}</div>
                                    <div class="row-data">
                                        <span class="row-primary">${h.address}</span>
                                        <span class="row-secondary">Stake: ${stake}%</span>
                                    </div>
                                </div>
                                <div class="row-meta">
                                    <span class="row-primary">${h.balance.toLocaleString()} HOME</span>
                                    <span class="badge-pill" style="margin-top:4px">HOLDING</span>
                                </div>
                            </div>
                        `;
                    });
                }

                // Validators List
                const validatorsList = document.getElementById('validatorsList');
                if (validatorsList) {
                    const uniqueValidators = [...new Set(chain.map(b => b.validator))].filter(v => v && v !== "SYSTEM");

                    // Update Dashboard Stat if exists (we use 'Active Validators' label sometimes)
                    // Currently 'Active Validators' card was replaced by 'Total Holders', 
                    // but if it ever returns, we can update it here.

                    validatorsList.innerHTML = '';
                    if (uniqueValidators.length === 0) {
                        validatorsList.innerHTML = '<div style="padding:40px; text-align:center; color:#555">No external validators detected.</div>';
                    }

                    uniqueValidators.forEach(v => {
                        validatorsList.innerHTML += `
                            <div class="table-row">
                                <div style="display:flex; align-items:center">
                                    <div class="row-icon">VN</div>
                                    <div class="row-data">
                                        <span class="row-primary">${v}</span>
                                        <span class="row-secondary">Mainnet Node</span>
                                    </div>
                                </div>
                                <div class="row-meta">
                                    <span class="badge-pill">ACTIVE</span>
                                    <span class="row-secondary" style="margin-top:4px">Status: Validating</span>
                                </div>
                            </div>
                        `;
                    });
                }

            } catch (err) {
                console.error("Render Error:", err);
                log("Rendering error occurred. Check browser console.");
            }
        }

        function timeAgo(ts) {
            const seconds = Math.floor((Date.now() / 1000) - ts);
            if (seconds < 60) return seconds + "s ago";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + "m ago";
            const hours = Math.floor(minutes / 60);
            return hours + "h ago";
        }

        fetchChain();
        setInterval(fetchChain, 8000); // 8s refresh to reduce load
    </script>
</body>

</html>